---
- name: Verify Connection to Windows Host
  win_ping:

- name: Calculate Date Threshold for Password Age Query
  win_shell: |
    $thresholdDate = (Get-Date).AddDays(-30).ToString("yyyy-MM-dd")
    Write-Output $thresholdDate
  register: threshold_date

- name: Display calculated date threshold
  ansible.builtin.debug:
    msg: "Threshold Date for Password Query: {{ threshold_date.stdout }}"

- name: Query AD for Computers with Password Last Set Older than 30 Days
  win_shell: |
    $thresholdDate = "{{ threshold_date.stdout }}"
    $query = "PasswordLastSet -lt '$thresholdDate'"
    $securePassword = ConvertTo-SecureString '{{ hub_sa_password }}' -AsPlainText -Force
    $credential = New-Object System.Management.Automation.PSCredential('{{ hub_sa_user }}', $securePassword)
    $computers = Get-ADComputer -Filter $query -Credential $credential -Properties PasswordLastSet
    $computers | ForEach-Object { Write-Host "$($_.Name): $($_.PasswordLastSet)" }
  register: ad_computer_query

- name: Filter AD computers based on password set date
  set_fact:
    filtered_computers: "{{ ad_computer_query.stdout_lines | selectattr('search', 'search', threshold_date.stdout) | list }}"

- name: Initialize dictionary for old password computers
  set_fact:
    computers_dict: "{{ filtered_computers | map('regex_replace', '(.*): (.*)', '{\"computerName\": \"\\1\", \"passwordLastSet\": \"\\2\"}') | list }}"

- name: Display dictionary of filtered computers
  ansible.builtin.debug:
    msg: "{{ computers_dict }}"
