---
- name: Verify Connection to Windows Host
  win_ping:

- name: Calculate Date Threshold for Password Age Query
  win_shell: |
    $thresholdDate = (Get-Date).AddDays(-30).ToString("yyyy-MM-dd")
    Write-Output $thresholdDate
  register: threshold_date

- name: Display calculated date threshold
  ansible.builtin.debug:
    msg: "Threshold Date for Password Query: {{ threshold_date.stdout }}"

- name: Query AD for Computers with Password Last Set Older than 30 Days
  win_shell: |
    $thresholdDate = "{{ threshold_date.stdout }}"
    $query = "PasswordLastSet -lt '$thresholdDate'"
    $securePassword = ConvertTo-SecureString '{{ hub_sa_password }}' -AsPlainText -Force
    $credential = New-Object System.Management.Automation.PSCredential('{{ hub_sa_user }}', $securePassword)
    $computers = Get-ADComputer -Filter $query -Credential $credential -Properties PasswordLastSet
    $computers | ForEach-Object { Write-Host "$($_.Name): $($_.PasswordLastSet)" }
  register: ad_computer_query

- name: Display first 10 lines of AD computer query output
  ansible.builtin.debug:
    msg: "{{ ad_computer_query.stdout_lines[:10] }}"

- name: Convert AD output to a list of dictionaries with computer name and last password change date
  set_fact:
    devices: "{{ ad_computer_query.stdout_lines | map('split', ': ') | map('dict', ['deviceName', 'lastPasswordChange']) | list }}"

- name: Format lastPasswordChange to ISO format
  set_fact:
    formatted_devices: "{{ devices | map(attribute='lastPasswordChange', format_timestamp('%Y-%m-%dT%H:%M:%SZ')) | list }}"

- name: Display formatted devices with last password change
  ansible.builtin.debug:
    msg: "{{ formatted_devices }}"
